{% extends 'layout2.html' %}
{% load render_partial %}
{% load poll_extras %}

{% block title %}
    لیست محصولات
{% endblock %}
{% block links %}
    <link rel="stylesheet" href="/static/lib/sweetalert/sweetalert2.min.css">
{% endblock %}
{% block content %}
    <body class="sticky-header">
    <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a
            href="https://browsehappy.com/">upgrade
        your browser</a> to improve your experience and security.</p>
    <![endif]-->
    <a href="#top" class="back-to-top" id="backto-top"><i class="fal fa-arrow-up"></i></a>

    <main class="main-wrapper">
        <!-- Start Breadcrumb Area  -->
        <div class="axil-breadcrumb-area">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 col-md-8">
                        <div class="inner">
                            <ul class="axil-breadcrumb">
                                <li class="axil-breadcrumb-item"><a href="{% url 'home' %}">خانه</a></li>
                                <li class="separator"></li>
                                <li class="axil-breadcrumb-item active" aria-current="page">فروشگاه</li>
                            </ul>
                            <h1 class="title">همه محصولات را کاوش کنید</h1>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-4">
                        <div>
                            <div class="bradcrumb-thumb" id="clock" style="font-size: 2em; text-align: left;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Breadcrumb Area  -->

        <!-- Start Shop Area  -->
        <div class="axil-shop-area axil-section-gap bg-color-white">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3">
                        {% render_partial 'product_module.views.render_partial_sidebar' %}
                        <!-- End .axil-shop-sidebar -->
                    </div>
                    <div class="col-lg-9">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="axil-shop-top mb--40">
                                    <div class="category-select align-items-center justify-content-lg-end justify-content-between">
                                        <!-- Start Single Select  -->
                                        <form method="GET" action="{% url 'product_list' %}">
                                            <span class="filter-results">نمایش 1-12 از {{ total_products }} محصول</span>
                                            <select style="width: 150px;" class="single-select" name="sort_by"
                                                    onchange="this.form.submit()">
                                                <option value="newest"
                                                        {% if request.GET.sort_by == 'newest' %}selected{% endif %}>
                                                    جدیدترین
                                                </option>
                                                <option value="price_desc"
                                                        {% if request.GET.sort_by == 'price_desc' %}selected{% endif %}>
                                                    قیمت (زیاد به کم)
                                                </option>
                                                <option value="price"
                                                        {% if request.GET.sort_by == 'price' %}selected{% endif %}>
                                                    قیمت (کم به زیاد)
                                                </option>
                                                <option value="visit"
                                                        {% if request.GET.sort_by == 'visit' %}selected{% endif %}>
                                                    پربازدیدترین
                                                </option>
                                                <option value="sale"
                                                        {% if request.GET.sort_by == 'sale' %}selected{% endif %}>
                                                    پرفروش ترین
                                                </option>
                                                <option value="discount"
                                                        {% if request.GET.sort_by == 'discount' %}selected{% endif %}>
                                                    بیشترین تخفیف
                                                </option>
                                            </select>
                                        </form>
                                        <!-- End Single Select  -->
                                    </div>
                                    <div class="d-lg-none">
                                        <button class="product-filter-mobile filter-toggle"><i
                                                class="fas fa-filter"></i> فیلتر
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End .row -->
                        <div class="row row--15" id="product-container">
                            {% for product in products %}
                                <div class="col-xl-3 col-lg-4 col-sm-6">
                                    <div class="axil-product product-style-one has-color-pick mt--40">
                                        <div class="thumbnail">
                                            <a href="{% url 'product_detail' product.slug %}"
                                               style="max-width: 100%; max-height: 200px; object-fit: contain; display: flex; justify-content: center; align-items: center;">
                                                <img src="{{ product.mainimage.url }}"
                                                     alt="Product Images">
                                            </a>
                                            {% if product.discount %}
                                                <div class="label-block label-right">
                                                    <div class="product-badget">{{ product.get_discount_display }}
                                                        تخفیف
                                                    </div>
                                                </div>
                                            {% endif %}
                                            <div class="product-hover-action">
                                                <ul class="cart-action">
                                                    {% if request.user.is_authenticated %}
                                                        <li class="wishlist"><a onclick="add_to_wish({{ product.id }})"
                                                                                href="#"><i
                                                                class="far fa-heart"></i></a></li>
                                                    {% else %}
                                                        <li class="wishlist"><a onclick="add_to_wish({{ product.id }})"
                                                                                href="{% url 'login' %}"><i
                                                                class="far fa-heart"></i></a></li>
                                                    {% endif %}
                                                    <li class="select-option"><a
                                                            href="{% url 'product_detail' product.slug %}">جزئیات</a>
                                                    </li>
                                                    <li class="quickview"><a href="{% url 'product_detail' product.slug %}"><i
                                                            class="far fa-eye"></i></a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="product-content">
                                            <div class="inner">
                                                <h5 class="title"><a
                                                        href="{% url 'product_detail' product.slug %}">{{ product.title }}</a>
                                                </h5>
                                                {% if product.count and product.price %}
                                                    <div class="product-price-variant">
                                                        <span class="price current-price">{{ product.final_price|digits }} تومان</span>
                                                        {% if product.discount %}
                                                            <span class="price old-price">{{ product.price|digits }}</span>
                                                        {% endif %}
                                                    </div>
                                                {% elif product.count and product.price is None %}
                                                    <div class="product-price-variant">
                                                        <span class="price current-price">رایگان</span>
                                                    </div>
                                                {% else %}
                                                    <div class="product-price-variant">
                                                        <span class="price current-price">ناموجود</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="post-pagination">
                            <nav class="navigation pagination" aria-label="Products">
                                <ul class="page-numbers">
                                    {% if page_obj.has_previous %}
                                        <li>
                                            <a class="page-numbers"
                                               href="?page={{ page_obj.previous_page_number }}&sort_by={{ request.GET.sort_by|default:'latest' }}"
                                               aria-label="Previous">
                                                <i class="fal fa-arrow-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    {% for page in paginator.page_range %}
                                        <li>{% if page_obj.number == page %}
                                            <span aria-current="page" class="page-numbers current">{{ page }}</span>
                                        {% else %}
                                            <li><a class="page-numbers"
                                                   href="?page={{ page }}&sort_by={{ request.GET.sort_by|default:'latest' }}">{{ page }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if page_obj.has_next %}
                                        <li>
                                            <a class="page-numbers"
                                               href="?page={{ page_obj.next_page_number }}&sort_by={{ request.GET.sort_by|default:'latest' }}"
                                               aria-label="Next">
                                                <i class="fal fa-arrow-left"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End .container -->
        </div>
        <!-- End Shop Area  -->
    </main>
    <div class="service-area">
        <div class="container">
            <div class="row row-cols-xl-4 row-cols-sm-2 row-cols-1 row--20">
                <div class="col">
                    <div class="service-box service-style-2">
                        <div class="icon">
                            <img src="/static/images/icons/service1.png" alt="Service">
                        </div>
                        <div class="content">
                            <h6 class="title">ارسال سریع و ایمن</h6>
                            <p>برای تمامی سفارشات.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="service-box service-style-2">
                        <div class="icon">
                            <img src="/static/images/icons/service2.png" alt="Service">
                        </div>
                        <div class="content">
                            <h6 class="title">گارانتی بازگشت وجه</h6>
                            <p>حتی بیشتر از 7 روز.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="service-box service-style-2">
                        <div class="icon">
                            <img src="/static/images/icons/service3.png" alt="Service">
                        </div>
                        <div class="content">
                            <h6 class="title">مرجوعی طی 24 ساعت</h6>
                            <p>بدون سوال.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="service-box service-style-2">
                        <div class="icon">
                            <img src="/static/images/icons/service4.png" alt="Service">
                        </div>
                        <div class="content">
                            <h6 class="title">پشتیبانی کامل</h6>
                            <p>24/7 پشتیبان آنلاین است.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </body>
{% endblock %}
{% block scripts %}
    <script>
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        setInterval(updateClock, 1000);
        updateClock();
    </script>
    <script src="/static/js/vendor/product_detail.js"></script>
    <script src="/static/lib/sweetalert/sweetalert2.all.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const filterButton = document.getElementById('apply-filters');
            const checkboxes = document.querySelectorAll('.shop-submenu ul li input[type="checkbox"]');
            const container = document.getElementById('product-container');
            const paginationContainer = document.querySelector('.post-pagination');
            let currentPage = 1;

            function applyFilters(page) {
                const selectedCategories = Array.from(checkboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);

                fetch('/products/filter-products/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({categories: selectedCategories, page: page}),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('🔍 داده‌های محصولات:', data);
                        updateProductList(data.products);
                        updatePagination(data.total_pages, data.current_page);
                    })
                    .catch(error => {
                        console.error('❌ خطا در دریافت داده‌ها:', error);
                    });
            }

            function updateProductList(products) {
                container.innerHTML = '';

                if (!products || products.length === 0) {
                    container.innerHTML = '<p>هیچ محصولی یافت نشد.</p>';
                    return;
                }

                products.forEach(product => {
                    const productElement = document.createElement('div');
                    productElement.classList.add('col-xl-3', 'col-lg-4', 'col-sm-6');
                    productElement.innerHTML = `
                <div class="axil-product product-style-one has-color-pick mt--40">
                    <div class="thumbnail">
                        <a href="/product/${product.slug}">
                            <img src="${product.image}" alt="${product.title}" style="max-width: 100%; max-height: 200px; object-fit: contain;">
                        </a>
                    </div>
                    <div class="product-content">
                        <h5 class="title"><a href="/product/${product.slug}">${product.title}</a></h5>
                        <div class="product-price-variant">
                            <span class="price current-price">${product.price} تومان</span>
                        </div>
                    </div>
                </div>
            `;
                    container.appendChild(productElement);
                });
            }

            function updatePagination(totalPages, currentPage) {
                paginationContainer.innerHTML = `
            <nav class="navigation pagination" aria-label="Products">
                <ul class="page-numbers">
                    ${Array.from({length: totalPages}, (_, i) => i + 1)
                    .map(page => `
                            <li>
                                <a class="page-numbers ${page === currentPage ? 'current' : ''}" href="#" data-page="${page}">
                                    ${page}
                                </a>
                            </li>
                        `).join('')}
                </ul>
            </nav>
        `;

                const pageLinks = paginationContainer.querySelectorAll('.page-numbers a');
                pageLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'), 10);
                        if (page && page !== currentPage) {
                            currentPage = page;
                            applyFilters(currentPage);
                        }
                    });
                });
            }

            filterButton.addEventListener('click', function () {
                currentPage = 1;
                applyFilters(currentPage);
            });
        });
    </script>
{% endblock %}


